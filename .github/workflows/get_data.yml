name: Colorado power outages
on:
    push:
    workflow_dispatch:
    schedule:
    - cron: '0,30 * * * *'
jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Save previous snapshot for comparison
        run: |-
          # Save current data as previous snapshot before fetching new data
          if [ -f xcel-outages.json ]; then
            cp xcel-outages.json xcel-outages-previous.json
          else
            echo '{"type":"FeatureCollection","features":[]}' > xcel-outages-previous.json
          fi
          if [ -f blackhills-outages.json ]; then
            cp blackhills-outages.json blackhills-outages-previous.json
          else
            echo '[]' > blackhills-outages-previous.json
          fi
      - name: Fetch Xcel Energy data
        run: |-
          curl -s 'https://emcs-gis.esriemcs.com/arcgis/rest/services/Xcel/XcelOutage/MapServer/3/query?where=1%3D1&text=&objectIds=&time=&timeRelation=esriTimeRelationOverlaps&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&distance=&units=esriSRUnit_Foot&relationParam=&outFields=*&returnGeometry=true&returnTrueCurves=false&maxAllowableOffset=&geometryPrecision=&outSR=&havingClause=&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&historicMoment=&returnDistinctValues=false&resultOffset=&resultRecordCount=&returnExtentOnly=false&sqlFormat=none&datumTransformation=&parameterValues=&rangeValues=&quantizationParameters=&uniqueIds=&returnUniqueIdsOnly=false&featureEncoding=esriDefault&f=geojson' > xcel-outages.json
      - name: Fetch Xcel Energy shutoff watch areas
        run: |-
          curl -s 'https://emcs-gis.esriemcs.com/arcgis/rest/services/Xcel/XcelOutage/MapServer/4/query?where=1%3D1&text=&objectIds=&time=&timeRelation=esriTimeRelationOverlaps&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&distance=&units=esriSRUnit_Foot&relationParam=&outFields=*&returnGeometry=true&returnTrueCurves=false&maxAllowableOffset=&geometryPrecision=&outSR=&havingClause=&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&historicMoment=&returnDistinctValues=false&resultOffset=&resultRecordCount=&returnExtentOnly=false&sqlFormat=none&datumTransformation=&parameterValues=&rangeValues=&quantizationParameters=&uniqueIds=&returnUniqueIdsOnly=false&featureEncoding=esriDefault&f=geojson' > xcel-shutoff-watch.json
      - name: Fetch Black Hills Energy data
        run: |-
          curl -sL 'https://www.blackhillsenergy.com/POP/model/PopOutage?ServiceType=Electric' > blackhills-outages.json
      - name: Tally hourly Colorado outages by provider and area
        run: |-
          # Only run on the hour (minute 0-5 to account for workflow delay)
          current_minute=$(date -u +%M)
          if [ "$current_minute" -lt 6 ]; then
            # Create header if file doesn't exist
            if [ ! -f outage-history.csv ]; then
              echo "timestamp,provider,area,outages,customers" > outage-history.csv
            fi
            
            timestamp=$(date -u +%Y-%m-%dT%H:00:00Z)
            
            # Tally Xcel Energy Colorado outages by county
            jq -r --arg ts "$timestamp" '
              .features 
              | map(select(.properties.states == "CO"))
              | group_by(.properties.county)
              | map({
                  area: .[0].properties.county,
                  outages: length,
                  customers: (map(.properties.customers) | add)
                })
              | .[]
              | [$ts, "Xcel Energy", .area, .outages, .customers]
              | @csv
            ' xcel-outages.json >> outage-history.csv
            
            # Tally Black Hills Energy outages by area
            jq -r --arg ts "$timestamp" '
              group_by(.fieldValues.geographicAorIDs)
              | map({
                  area: .[0].fieldValues.geographicAorIDs,
                  outages: length,
                  customers: (map(.currentAffected) | add)
                })
              | .[]
              | [$ts, "Black Hills Energy", .area, .outages, .customers]
              | @csv
            ' blackhills-outages.json >> outage-history.csv 2>/dev/null || true
            
            # Log summary
            xcel_outages=$(jq '[.features[] | select(.properties.states == "CO")] | length' xcel-outages.json)
            bh_outages=$(jq 'length' blackhills-outages.json 2>/dev/null || echo "0")
            echo "Recorded ${xcel_outages} Xcel Energy outages, ${bh_outages} Black Hills Energy outages"
          else
            echo "Skipping hourly tally (minute: ${current_minute})"
          fi
      - name: Commit and push if it changed
        run: |-
          git config user.name "Automated"
          git config user.email "actions@users.noreply.github.com"
          git add -A
          timestamp=$(date -u)
          git commit -m "Updated: ${timestamp}" || exit 0
          git push